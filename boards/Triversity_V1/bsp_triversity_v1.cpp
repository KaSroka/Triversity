/* ========================================================================================================================== */ /**
 @license    BSD 3-Clause
 @copyright  microHAL
 @version    $Id$
 @brief      board support package for stm32f4Discovery board

 @authors    Pawel Okas
 created on: 16-04-2014
 last modification: <DD-MM-YYYY>

 @copyright Copyright (c) 2014, microHAL
 All rights reserved.
 Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following
 conditions are met:
 	 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
 	 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer
 	 	in the documentation and/or other materials provided with the distribution.
 	 3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived
 	 	from this software without specific prior written permission.
 THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
 SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
 OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

 */ /* ==========================================================================================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     */
#include <array>

#include "microhal.h"
#include "microhal_bsp.h"

#include "RX5808.h"
#include "SSD1306.h"

#include "Instance.h"

#include "ports/stm32f3xx/device/stm32f3xx.h"

using namespace microhal;
using namespace stm32f3xx;

extern "C" int main(int, void *);
extern "C" void vApplicationTickHook(void);
extern "C" void low_level_init_0(void);
extern "C" void vApplicationMallocFailedHook(void);

static void run_main(void *) {
    Instance::Init();
    main(0, nullptr);
    vTaskSuspend(NULL);
}

void low_level_init_0(void) {
    Core::fpu_enable();
}

void hardwareConfig(void) {
    (void)bsp::Display::spi;
    (void)bsp::VideoRx::spi;

    Core::fpu_enable();

    ClockManager::HSI::enable();
    ClockManager::PLL::clockSource(ClockManager::PLL::ClockSource::HSIDiv2);
    ClockManager::PLL::frequency(64000000);
    ClockManager::SYSCLK::source(ClockManager::SYSCLK::Source::PLL);

    IOManager::routeSPI<1, MOSI, stm32f3xx::GPIO::PortB, 5>();
    IOManager::routeSPI<1, SCK, stm32f3xx::GPIO::PortB, 3>();

    IOManager::routeSPI<3, MOSI, stm32f3xx::GPIO::PortC, 12>();
    IOManager::routeSPI<3, SCK, stm32f3xx::GPIO::PortC, 10>();

    IOManager::routeI2C<2, SDA, stm32f3xx::GPIO::PortF, 0>();
    IOManager::routeI2C<2, SCL, stm32f3xx::GPIO::PortF, 1>();

    IOManager::routeADC<stm32f3xx::GPIO::PortA, 1>();
    IOManager::routeADC<stm32f3xx::GPIO::PortA, 3>();
    IOManager::routeADC<stm32f3xx::GPIO::PortA, 4>();
    IOManager::routeADC<stm32f3xx::GPIO::PortA, 6>();

    microhal::stm32f3xx::ExternalInterrupt::connect(Instance::GetTouchController().TSCInterruptSlot, Instance::GetTouchController(), 2);

    stm32f3xx::SPI::spi1.init(stm32f3xx::SPI::Mode0, stm32f3xx::SPI::Prescaler2);
    stm32f3xx::SPI::spi1.enable();

    stm32f3xx::SPI::spi3.init(stm32f3xx::SPI::Mode0, stm32f3xx::SPI::Prescaler8);
    SPI3->CR1 |= SPI_CR1_LSBFIRST;
    stm32f3xx::SPI::spi3.enable();

    stm32f3xx::I2C::i2c2.init();
    stm32f3xx::I2C::i2c2.speed(400000, microhal::I2C::Mode::Fast);
    stm32f3xx::I2C::i2c2.enable();

    Instance::GetTouchController().Init();

    xTaskCreate(run_main, "MAIN", 256 + 40, nullptr, tskIDLE_PRIORITY, nullptr);

    vTaskStartScheduler();
}

void vApplicationTickHook(void) {
    TSL_tim_ProcessIT();
}

void vApplicationMallocFailedHook(void) {
    while (1)
        ;
}
